<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Clan Dashboard</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase Client SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { dark: '#0b0e14', card: '#151b28', primary: '#6366f1' }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0b0e14;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        .glass {
            background: rgba(21, 27, 40, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .tooltip-wrap {
            position: relative;
            display: inline-block;
        }

        .tooltip-wrap .tooltip-text {
            visibility: hidden;
            background-color: #334155;
            color: #fff;
            text-align: center;
            padding: 5px 10px;
            border-radius: 6px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
            font-size: 0.75rem;
            pointer-events: none;
        }

        .tooltip-wrap:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Sortable Header Styles */
        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }

        th.sortable:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .sort-icon {
            display: inline-block;
            margin-left: 6px;
            font-size: 0.7em;
            color: #475569;
            transition: color 0.2s;
        }

        th.active-sort .sort-icon {
            color: #a5b4fc;
        }
    </style>
</head>

<body class="bg-dark text-slate-300 font-sans min-h-screen p-4 md:p-8">

    <div class="max-w-[1600px] mx-auto space-y-8">

        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-white tracking-tight">
                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">CLAN</span>
                    TRACKER
                </h1>
                <p class="text-slate-500 text-sm font-medium">Live Economy Database</p>
            </div>
            <div class="flex items-center gap-2 px-4 py-2 bg-green-500/10 border border-green-500/20 rounded-full">
                <span class="animate-pulse h-2 w-2 rounded-full bg-green-400"></span>
                <span class="text-green-400 text-xs font-bold tracking-wide uppercase">Live Connection</span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="glass rounded-xl p-5 relative overflow-hidden group">
                <div class="relative z-10">
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Total Wing Cores</p>
                    <h2 class="text-3xl font-black text-white mt-1" id="totalWingCore">0</h2>
                </div>
                <i
                    class="fa-solid fa-feather-pointed absolute -bottom-2 -right-2 text-7xl text-purple-500/20 group-hover:scale-110 transition duration-500"></i>
            </div>
            <div class="glass rounded-xl p-5 relative overflow-hidden group">
                <div class="relative z-10">
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Total Herbs</p>
                    <h2 class="text-3xl font-black text-green-400 mt-1" id="totalHerbs">0</h2>
                </div>
                <i
                    class="fa-solid fa-leaf absolute -bottom-2 -right-2 text-7xl text-green-500/20 group-hover:scale-110 transition duration-500"></i>
            </div>
            <div class="glass rounded-xl p-5 relative overflow-hidden group">
                <div class="relative z-10">
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Total Souls</p>
                    <h2 class="text-3xl font-black text-cyan-400 mt-1" id="totalSoul">0</h2>
                </div>
                <i
                    class="fa-solid fa-fire-flame-simple absolute -bottom-2 -right-2 text-7xl text-cyan-500/20 group-hover:scale-110 transition duration-500"></i>
            </div>
            <div class="glass rounded-xl p-5 relative overflow-hidden group">
                <div class="relative z-10">
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Members Tracked</p>
                    <h2 class="text-3xl font-black text-white mt-1" id="totalPlayers">0</h2>
                </div>
                <i
                    class="fa-solid fa-users absolute -bottom-2 -right-2 text-7xl text-slate-500/20 group-hover:scale-110 transition duration-500"></i>
            </div>
        </div>

        <div class="glass p-3 rounded-xl flex flex-wrap gap-3 items-center">
            <div class="relative flex-grow min-w-[250px]">
                <i class="fa-solid fa-search absolute left-4 top-3.5 text-slate-500 text-sm"></i>
                <input type="text" id="searchInput" onkeyup="renderTable()"
                    class="w-full bg-slate-800/50 border border-slate-700/50 text-white text-sm rounded-lg pl-10 pr-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                    placeholder="Search player...">
            </div>
            <select id="guildFilter" onchange="renderTable()"
                class="bg-slate-800/50 border border-slate-700/50 text-white text-sm rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                <option value="All">All Guilds</option>
            </select>
            <button onclick="fetchData()"
                class="p-3 bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition"><i
                    class="fa-solid fa-rotate"></i></button>
        </div>

        <div class="glass rounded-xl overflow-hidden shadow-2xl overflow-x-auto">
            <table class="w-full text-left whitespace-nowrap">
                <thead>
                    <tr class="bg-slate-800/80 text-slate-400 text-xs uppercase font-bold tracking-wider">
                        <!-- Row number -->
                        <th class="p-4">#</th>
                        <th class="p-4 sortable" onclick="handleSort('username')">Player <i id="icon-username"
                                class="sort-icon fa-solid fa-sort"></i></th>
                        <th class="p-4 sortable" onclick="handleSort('guild')">Guild <i id="icon-guild"
                                class="sort-icon fa-solid fa-sort"></i></th>
                        <th class="p-4 text-right text-purple-400 sortable" onclick="handleSort('wing_core')">Wing Core
                            <i id="icon-wing_core" class="sort-icon fa-solid fa-sort"></i>
                        </th>
                        <th class="p-4 text-right text-yellow-400 sortable" onclick="handleSort('gold')">Gold <i
                                id="icon-gold" class="sort-icon fa-solid fa-sort"></i></th>
                        <th class="p-4 text-right text-fuchsia-400 sortable" onclick="handleSort('purple_diamond')">P.
                            Diamond <i id="icon-purple_diamond" class="sort-icon fa-solid fa-sort"></i></th>
                        <th class="p-4 text-right text-gray-400 sortable" onclick="handleSort('ore')">Ore <i
                                id="icon-ore" class="sort-icon fa-solid fa-sort"></i></th>
                        <th class="p-4 text-right text-green-400 sortable" onclick="handleSort('herb')">Herb <i
                                id="icon-herb" class="sort-icon fa-solid fa-sort"></i></th>
                        <th class="p-4 text-right text-yellow-400 sortable" onclick="handleSort('guild_coin')">Guild Coin <i
                                id="icon-guild_coin" class="sort-icon fa-solid fa-sort"></i></th>
                        <!-- Soul -->
                        <th class="p-4 text-right text-pink-400 sortable" onclick="handleSort('soul')">Soul <i
                                id="icon-soul" class="sort-icon fa-solid fa-sort"></i></th>
                        <th class="p-4 text-right sortable" onclick="handleSort('last_updated')">Updated <i
                                id="icon-last_updated" class="sort-icon fa-solid fa-sort"></i></th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="divide-y divide-slate-700/50 text-sm"></tbody>
            </table>
            <div id="emptyState" class="hidden p-12 text-center">
                <i class="fa-solid fa-inbox text-4xl text-slate-600 mb-3"></i>
                <p class="text-slate-500 font-medium">No data found.</p>
            </div>
        </div>

    </div>

    <script>
        // --- Supabase Config ---
        const SUPABASE_URL = "https://jenqldfrbwzbnqkurwrm.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplbnFsZGZyYnd6Ym5xa3Vyd3JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4Mzg5MjcsImV4cCI6MjA4NDQxNDkyN30.q0-99ishp3kqLwTgdZYwsxGtmmuAxCzQr3RtTQZqF2w";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allData = [];
        let avatarCache = {}; // Cache for Roblox avatar URLs
        let currentSort = { key: 'wing_core', order: 'desc' };

        async function fetchData() {
            try {
                const btn = document.querySelector('.fa-rotate');
                if (btn) btn.classList.add('fa-spin');

                // Fetch directly from Supabase
                const { data, error } = await supabaseClient
                    .from('account_stat')
                    .select('*');

                if (error) throw error;

                // Map data to maintain compatibility with existing render logic
                allData = data.map(item => {
                    let parsedJSON = {};
                    if (item.data) {
                        if (typeof item.data === 'string') {
                            try { parsedJSON = JSON.parse(item.data); } catch (e) { console.error("Parse Error", e); }
                        } else {
                            parsedJSON = item.data;
                        }
                    }
                    
                    // Merging root and parsed data for easier access (flattening)
                    return {
                        ...item,
                        ...parsedJSON,
                        data: parsedJSON // Keep for backward compatibility
                    };
                });

                populateGuilds();
                renderTable();
                if (btn) setTimeout(() => btn.classList.remove('fa-spin'), 500);
            } catch (e) { 
                console.error("Supabase Fetch Error:", e);
                const connectionText = document.querySelector('.text-green-400');
                if (connectionText) {
                    connectionText.innerText = "Connection Error";
                    connectionText.parentElement.classList.replace('bg-green-500/10', 'bg-red-500/10');
                    connectionText.parentElement.classList.replace('border-green-500/20', 'border-red-500/20');
                    connectionText.previousElementSibling.classList.replace('bg-green-400', 'bg-red-400');
                }
            }
        }

        // Setup Realtime Subscription
        function setupRealtime() {
            supabaseClient
                .channel('schema-db-changes')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'account_stat' },
                    (payload) => {
                        console.log('Change received!', payload);
                        fetchData(); // Simple approach: re-fetch on any change
                    }
                )
                .subscribe();
        }

        function handleSort(key) {
            if (currentSort.key === key) {
                currentSort.order = currentSort.order === 'desc' ? 'asc' : 'desc';
            } else {
                currentSort.key = key;
                currentSort.order = 'desc';
            }
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filter = document.getElementById('guildFilter').value;

            tbody.innerHTML = '';

            // Sort Icons Update
            document.querySelectorAll('.sort-icon').forEach(icon => icon.className = 'sort-icon fa-solid fa-sort');
            document.querySelectorAll('th').forEach(th => th.classList.remove('active-sort'));
            const activeIcon = document.getElementById(`icon-${currentSort.key}`);
            if (activeIcon) {
                activeIcon.className = `sort-icon fa-solid fa-sort-${currentSort.order === 'asc' ? 'up' : 'down'}`;
                activeIcon.parentElement.classList.add('active-sort');
            }

            // Sort Data
            const sorted = [...allData].sort((a, b) => {
                const getValue = (obj, key) => {
                    if (key === 'username') return obj.username || "";
                    if (key === 'last_updated') return new Date(obj.last_updated).getTime();
                    if (key === 'guild') return obj.guild || "";
                    return obj[key] || 0;
                };

                const valA = getValue(a, currentSort.key);
                const valB = getValue(b, currentSort.key);

                if (typeof valA === 'string') {
                    return currentSort.order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else {
                    return currentSort.order === 'asc' ? valA - valB : valB - valA;
                }
            });

            let sumWings = 0, sumHerbs = 0, sumDiamond = 0, sumSoul = 0, count = 0;

            sorted.forEach(p => {
                const s = p.stats || {};
                const username = p.username || "Unknown";
                const name = p.name || "Unknown";

                // --- AVATAR LOGIC (GitHub Pages Compatible) ---
                const uId = p.user_id || p.userId || p.userid || p.uId;
                const placeholder = 'https://tr.rbxcdn.com/535451b4737194f1345464190da90eb4/150/150/AvatarHeadshot/Png';
                
                // We use the cache if exists, otherwise show placeholder and fetch in background
                let finalAvatarUrl = avatarCache[uId] || placeholder;

                if (uId && !avatarCache[uId] && !isNaN(uId) && uId > 1000) {
                    // Fetch from RoProxy (CORS-friendly for GitHub Pages)
                    fetch(`https://thumbnails.roproxy.com/v1/users/avatar-headshot?userIds=${uId}&size=150x150&format=Png&isCircular=false`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.data && data.data[0] && data.data[0].imageUrl) {
                                avatarCache[uId] = data.data[0].imageUrl;
                                // Update the specific image element
                                const imgEl = document.getElementById(`avatar-${uId}-${count}`);
                                if (imgEl) imgEl.src = avatarCache[uId];
                            }
                        })
                        .catch(err => console.error("Avatar error", err));
                }

                const guild = p.guild || "No Guild";
                const guild_coin = p.guild_coin || 0;
                const wings = p.wing_core || 0;
                const gold = p.gold || 0;
                const diamond = p.diamond || 0;
                const pDiamond = p.arena_point || 0; 
                const ore = p.ore || 0;
                const herb = p.herbs || 0;
                const soul = p.soul || 0;
                const level = p.level || 0;

                if (filter !== "All" && guild !== filter) return;
                if (search && !name.toLowerCase().includes(search)) return;

                sumWings += parseInt(wings);
                sumHerbs += parseInt(herb);
                sumDiamond += parseInt(diamond);
                sumSoul += parseInt(soul);
                count++;

                const row = `
                    <tr class="hover:bg-slate-700/30 transition">
                        <td class="p-4">${count}</td>
                        <td class="p-4 font-semibold text-white flex items-center gap-3">
                            <img id="avatar-${uId}-${count}"
                                 src="${finalAvatarUrl}" 
                                 onerror="this.src='${placeholder}'; this.onerror=null;"
                                 class="h-10 w-10 rounded-full bg-slate-800 object-cover border border-slate-600 shadow-sm" alt="${username}">
                            <div class="flex flex-col leading-tight">
                                <span class="text-white">${name}</span>
                                <span class="text-sm text-slate-400 font-normal">${username} / ${level}</span>
                            </div>
                        </td>
                        <td class="p-4"><span class="px-2 py-1 rounded text-xs bg-slate-700 text-slate-300 border border-slate-600">${guild}</span></td>
                        <td class="p-4 text-right font-mono text-purple-300 font-bold">${formatStandard(wings)}</td>
                        <td class="p-4 text-right font-mono text-yellow-300 tooltip-wrap cursor-help">${formatCompact(gold)}<span class="tooltip-text">${formatStandard(gold)}</span></td>
                        <td class="p-4 text-right font-mono text-fuchsia-300">${formatStandard(pDiamond)}</td>
                        <td class="p-4 text-right font-mono text-slate-400">${formatCompact(ore)}</td>
                        <td class="p-4 text-right font-mono text-green-400">${formatCompact(herb)}</td>
                        <td class="p-4 text-right font-mono text-yellow-400">${formatStandard(guild_coin)}</td>
                        <td class="p-4 text-right font-mono text-pink-400">${soul}</td>
                        <td class="p-4 text-right text-xs text-slate-500">${timeAgo(p.last_updated)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            document.getElementById('totalWingCore').innerText = sumWings;
            document.getElementById('totalHerbs').innerText = formatCompact(sumHerbs);
            document.getElementById('totalSoul').innerText = formatCompact(sumSoul);
            document.getElementById('totalPlayers').innerText = count;
            document.getElementById('emptyState').style.display = count === 0 ? 'block' : 'none';
        }

        // --- Helpers ---
        function formatCompact(num) { if (!num) return "0"; return Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 }).format(num); }
        function formatStandard(num) { return num ? Math.floor(num).toLocaleString() : '0'; }
        function timeAgo(d) { const s = Math.floor((new Date() - new Date(d)) / 1000); if (s < 60) return "Just now"; if (s < 3600) return Math.floor(s / 60) + "m ago"; if (s < 86400) return Math.floor(s / 3600) + "h ago"; return "1d+ ago"; }
        function populateGuilds() {
            const cur = document.getElementById('guildFilter').value;
            const gs = new Set(allData.map(p => p.guild || "No Guild"));
            const sel = document.getElementById('guildFilter'); sel.innerHTML = '<option value="All">All Guilds</option>';
            Array.from(gs).filter(g => g && g !== "None").sort().forEach(g => { const o = document.createElement('option'); o.value = g; o.innerText = g; sel.appendChild(o) });
            sel.value = cur;
        }

        fetchData();
        setupRealtime();
    </script>
</body>

</html>
